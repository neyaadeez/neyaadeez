name: Update GitHub Stats Badges

on:
  schedule:
    - cron: "0 0 * * *"   # every day
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      
    - name: Get GitHub Stats
      id: stats
      run: |
        USERNAME="${{ github.repository_owner }}"

        # Commits
        COMMITS=$(curl -s -H "Accept: application/vnd.github.cloak-preview+json" \
          "https://api.github.com/search/commits?q=author:$USERNAME" | jq '.total_count')

        # PRs opened
        PRS_OPENED=$(curl -s \
          "https://api.github.com/search/issues?q=type:pr+author:$USERNAME" | jq '.total_count')

        # PRs reviewed
        PRS_REVIEWED=$(curl -s \
          "https://api.github.com/search/issues?q=type:pr+reviewed-by:$USERNAME" | jq '.total_count')

        # Issues opened
        ISSUES=$(curl -s \
          "https://api.github.com/search/issues?q=type:issue+author:$USERNAME" | jq '.total_count')

        # Repo count
        REPOS=$(curl -s "https://api.github.com/users/$USERNAME" | jq '.public_repos')

        echo "COMMITS=$COMMITS" >> $GITHUB_ENV
        echo "PRS_OPENED=$PRS_OPENED" >> $GITHUB_ENV
        echo "PRS_REVIEWED=$PRS_REVIEWED" >> $GITHUB_ENV
        echo "ISSUES=$ISSUES" >> $GITHUB_ENV
        echo "REPOS=$REPOS" >> $GITHUB_ENV

    - name: Update README
      run: |
        sed -i "s/Commits-[0-9A-Za-z]*/Commits-${COMMITS}/" README.md
        sed -i "s/PRs%20Opened-[0-9A-Za-z]*/PRs%20Opened-${PRS_OPENED}/" README.md
        sed -i "s/PRs%20Reviewed-[0-9A-Za-z]*/PRs%20Reviewed-${PRS_REVIEWED}/" README.md
        sed -i "s/Issues%20Opened-[0-9A-Za-z]*/Issues%20Opened-${ISSUES}/" README.md
        sed -i "s/Public%20Repos-[0-9A-Za-z]*/Public%20Repos-${REPOS}/" README.md

    - name: Commit changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Updated"
