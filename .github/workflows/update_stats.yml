name: Update GitHub Stats Badges

on:
  schedule:
    - cron: "0 0 * * 0"   # Every Sunday at 00:00 UTC (weekly)
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Get GitHub Stats
        id: stats
        run: |
          USERNAME="${{ github.repository_owner }}"

          # Total commits (all time, public)
          COMMITS=$(curl -s -H "Accept: application/vnd.github.cloak-preview+json" \
            "https://api.github.com/search/commits?q=author:$USERNAME" | jq '.total_count')

          # Total PRs opened (all time)
          PRS_OPENED=$(curl -s \
            "https://api.github.com/search/issues?q=type:pr+author:$USERNAME" | jq '.total_count')

          # Total PRs reviewed (all time)
          PRS_REVIEWED=$(curl -s \
            "https://api.github.com/search/issues?q=type:pr+reviewed-by:$USERNAME" | jq '.total_count')

          echo "COMMITS=$COMMITS" >> $GITHUB_ENV
          echo "PRS_OPENED=$PRS_OPENED" >> $GITHUB_ENV
          echo "PRS_REVIEWED=$PRS_REVIEWED" >> $GITHUB_ENV

      - name: Update README
        run: |
          sed -i "s/Commits-[0-9A-Za-z]*/Commits-${COMMITS}/" README.md
          sed -i "s/PRs%20Opened-[0-9A-Za-z]*/PRs%20Opened-${PRS_OPENED}/" README.md
          sed -i "s/PRs%20Reviewed-[0-9A-Za-z]*/PRs%20Reviewed-${PRS_REVIEWED}/" README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update GitHub stats badges"
          push_options: '--force'
